<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Property Card Distribution | Govt Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
:root{
  --bg:#f4f6f9;
  --card:#fff;
  --text:#222;
  --blue:#0b5ed7;
}
.dark{
  --bg:#121212;
  --card:#1e1e1e;
  --text:#eee;
  --blue:#4dabf7;
}
body{
  margin:0;
  font-family:system-ui,Arial;
  background:var(--bg);
  color:var(--text);
}
header{
  background:var(--blue);
  color:#fff;
  padding:14px;
  text-align:center;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:15px;
}
.card{
  background:var(--card);
  padding:15px;
  border-radius:8px;
  margin-bottom:15px;
}
button,select{
  padding:8px 12px;
  margin:4px;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  white-space:nowrap;
}
th{background:#eef3fb}
.dark th{background:#2a2a2a}

#map{height:300px}
</style>
</head>

<body>

<header>
  <h2>Property Card Distribution</h2>
  <p>SVAMITVA | Open Govt Data</p>
</header>

<div class="container">

<div class="card">
  <button onclick="loadData()">Load Data</button>
  <button onclick="toggleDark()">ðŸŒ™ Dark Mode</button>
  <button onclick="downloadCSV()">â¬‡ CSV</button>
</div>

<div class="card">
  <select id="stateFilter" onchange="applyFilter()">
    <option value="">All States</option>
  </select>
  <select id="districtFilter" onchange="applyFilter()">
    <option value="">All Districts</option>
  </select>
</div>

<div class="card">
  <canvas id="chart"></canvas>
</div>

<div class="card">
  <div id="map"></div>
</div>

<div class="card">
  <div style="overflow-x:auto">
    <table id="table"></table>
  </div>
</div>

</div>

<script>
const API_KEY="579b464db66ec23bdd000001dd4bec4f88d44e427141d80a8f9a5fcc";
const RESOURCE_ID="f978ad28-9827-4afe-8484-17133f736af7";

let records=[], map, chart;

async function loadData(){
  const res = await fetch(`https://api.data.gov.in/resource/${RESOURCE_ID}?api-key=${API_KEY}&format=json&limit=100`);
  const json = await res.json();
  records = json.records || [];
  buildTable(records);
  buildFilters(records);
  buildChart(records);
  buildMap(records);
}

function buildTable(data){
  if(!data.length) return;
  let html="<tr>";
  Object.keys(data[0]).forEach(k=>html+=`<th>${k}</th>`);
  html+="</tr>";
  data.forEach(r=>{
    html+="<tr>";
    Object.values(r).forEach(v=>html+=`<td>${v}</td>`);
    html+="</tr>";
  });
  table.innerHTML=html;
}

function buildFilters(data){
  let states=[...new Set(data.map(r=>r.state||r.State))];
  stateFilter.innerHTML='<option value="">All States</option>';
  states.forEach(s=>stateFilter.innerHTML+=`<option>${s}</option>`);
}

function applyFilter(){
  let s=stateFilter.value.toLowerCase();
  let d=districtFilter.value.toLowerCase();
  let f=records.filter(r=>{
    let st=(r.state||r.State||"").toLowerCase();
    let di=(r.district||r.District||"").toLowerCase();
    return (!s||st===s)&&(!d||di===d);
  });
  buildTable(f);
}

function buildChart(data){
  let count={};
  data.forEach(r=>{
    let s=r.state||r.State||"Unknown";
    count[s]=(count[s]||0)+1;
  });
  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"bar",
    data:{labels:Object.keys(count),
      datasets:[{label:"Records",data:Object.values(count)}]}
  });
}

function buildMap(data){
  if(!map){
    map=L.map("map").setView([22,78],5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  }
}

function downloadCSV(){
  let csv="";
  records.forEach((r,i)=>{
    if(i===0) csv+=Object.keys(r).join(",")+"\n";
    csv+=Object.values(r).join(",")+"\n";
  });
  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download="property_card.csv";
  a.click();
}

function toggleDark(){
  document.body.classList.toggle("dark");
}
</script>

</body>
</html>
