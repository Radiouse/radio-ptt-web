<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Daily Mandi Prices | Government of India</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f2f6fa;
  --card:#ffffff;
  --text:#1f2937;
  --blue:#002147;
  --border:#cfd8e3;
}
.dark{
  --bg:#0f172a;
  --card:#111827;
  --text:#e5e7eb;
  --blue:#2563eb;
  --border:#374151;
}
body{
  margin:0;
  font-family:Segoe UI,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.nic-top{
  background:#000;
  color:#fff;
  font-size:12px;
  padding:6px 14px;
}
header{
  background:linear-gradient(90deg,#001a33,#002147);
  color:#fff;
  padding:16px;
}
header h1{margin:0;font-size:22px}
header p{margin:4px 0 0;font-size:13px;opacity:.9}

.container{
  max-width:1400px;
  margin:auto;
  padding:16px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:6px;
  padding:14px;
  margin-bottom:14px;
}
button,select,input{
  padding:8px 10px;
  margin:4px;
  border:1px solid var(--border);
  border-radius:4px;
}
button{
  background:var(--blue);
  color:#fff;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border:1px solid var(--border);
  padding:6px;
  white-space:nowrap;
}
th{background:#e6effa}
.dark th{background:#1f2937}

footer{
  background:#f8fafc;
  border-top:2px solid #002147;
  padding:12px;
  text-align:center;
  font-size:12px;
  color:#374151;
}
.dark footer{
  background:#020617;
  color:#cbd5f5;
}
</style>
</head>

<body>

<div class="nic-top">
  Government of India | Ministry of Agriculture & Farmers Welfare
</div>

<header>
  <h1>Daily Market (Mandi) Prices</h1>
  <p>Open Government Data Platform India (NIC)</p>
</header>

<div class="container">

<div class="card">
  <button onclick="loadData()">Load / Refresh Data</button>
  <button onclick="toggleDark()">ðŸŒ™ Dark</button>
  <button onclick="downloadCSV()">â¬‡ CSV</button><br>

  <select id="stateFilter" onchange="applyFiltersSafe()">
    <option value="">All States</option>
  </select>

  <select id="commodityFilter" onchange="applyFiltersSafe()">
    <option value="">All Commodities</option>
  </select>

  <input type="date" id="dateFilter" onchange="applyFiltersSafe()">
  <input type="text" id="search" placeholder="Search mandi / district" onkeyup="applyFiltersSafe()">

  <div id="status">Idle</div>
</div>

<div class="card">
  <h3>ðŸ“Š Commodity-wise Comparison</h3>
  <canvas id="commodityChart"></canvas>
</div>

<div class="card">
  <h3>ðŸ“… Last 30 Days Price Trend</h3>
  <canvas id="trendChart"></canvas>
</div>

<div class="card" style="overflow-x:auto">
  <table id="table"></table>
</div>

</div>

<footer>
  Â© Government of India | Designed & Developed by NIC  
  <br>Data Source: data.gov.in
</footer>

<script>
/* ================= CONFIG ================= */
const API_KEY = "579b464db66ec23bdd000001dd4bec4f88d44e427141d80a8f9a5fcc";
const RESOURCE_ID = "9ef84268-d588-465a-a308-a864a43d0070";

/* ================= STATE ================= */
let allData = [];
let commodityChart = null;
let trendChart = null;

/* ================= UTILITIES ================= */
async function safeFetch(url, timeout = 15000){
  const controller = new AbortController();
  setTimeout(() => controller.abort(), timeout);
  const res = await fetch(url, { signal: controller.signal });
  if(!res.ok) throw new Error("FETCH_FAILED");
  return await res.text();
}

function parseXMLSafe(text){
  try{
    const xml = new DOMParser().parseFromString(text, "application/xml");
    if(xml.getElementsByTagName("parsererror").length) return null;
    return xml;
  }catch{ return null; }
}

function destroyChart(c){
  try{ if(c) c.destroy(); }catch{}
}

function clearUI(){
  table.innerHTML = "";
  destroyChart(commodityChart);
  destroyChart(trendChart);
}

/* ================= LOAD DATA ================= */
async function loadData(){
  status.innerText = "Loading dataâ€¦";
  clearUI();
  try{
    const xmlText = await safeFetch(
      `https://api.data.gov.in/resource/${RESOURCE_ID}?api-key=${API_KEY}&format=xml&limit=800`
    );

    const xml = parseXMLSafe(xmlText);
    if(!xml) throw new Error("XML_ERROR");

    const rows = [...xml.getElementsByTagName("record")];
    allData = rows.map(r=>{
      const o = {};
      [...r.children].forEach(c=>o[c.tagName] = c.textContent || "");
      return o;
    });

    if(!allData.length){
      status.innerText = "No data received";
      return;
    }

    buildFilters();
    applyFiltersSafe();
    status.innerText = `Updated successfully (${allData.length} records)`;
  }catch{
    status.innerText = "Service temporarily unavailable. Please try later.";
    clearUI();
  }
}

/* ================= FILTERS ================= */
function buildFilters(){
  stateFilter.innerHTML = '<option value="">All States</option>';
  commodityFilter.innerHTML = '<option value="">All Commodities</option>';

  [...new Set(allData.map(r=>r.state).filter(Boolean))]
    .forEach(s=>stateFilter.innerHTML+=`<option>${s}</option>`);

  [...new Set(allData.map(r=>r.commodity).filter(Boolean))]
    .forEach(c=>commodityFilter.innerHTML+=`<option>${c}</option>`);
}

function applyFiltersSafe(){
  if(!allData.length){ clearUI(); return; }

  const s = stateFilter.value.toLowerCase();
  const c = commodityFilter.value.toLowerCase();
  const q = search.value.toLowerCase();
  const d = dateFilter.value;

  const filtered = allData.filter(r=>{
    try{
      if(s && (r.state||"").toLowerCase()!==s) return false;
      if(c && (r.commodity||"").toLowerCase()!==c) return false;
      if(d && !(r.arrival_date||"").includes(d)) return false;
      if(q && !JSON.stringify(r).toLowerCase().includes(q)) return false;
      return true;
    }catch{ return false; }
  });

  buildTable(filtered);
  buildCommodityChart(filtered);
  buildTrendChart(filtered);
}

/* ================= TABLE ================= */
function buildTable(data){
  if(!data.length){ table.innerHTML=""; return; }
  let html="<tr>";
  Object.keys(data[0]).forEach(k=>html+=`<th>${k}</th>`);
  html+="</tr>";
  data.forEach(r=>{
    html+="<tr>";
    Object.values(r).forEach(v=>html+=`<td>${v}</td>`);
    html+="</tr>";
  });
  table.innerHTML=html;
}

/* ================= CHARTS ================= */
function buildCommodityChart(data){
  destroyChart(commodityChart);
  if(!data.length) return;

  const map={};
  data.forEach(r=>{
    const k=r.commodity||"Other";
    const p=parseFloat(r.modal_price||0);
    if(!isNaN(p)) map[k]=(map[k]||[]).concat(p);
  });

  const labels=Object.keys(map).slice(0,8);
  const values=labels.map(k=>{
    const a=map[k]; return (a.reduce((x,y)=>x+y,0)/a.length).toFixed(1);
  });

  commodityChart=new Chart(commodityChart,{
    type:"bar",
    data:{ labels,
      datasets:[{label:"Avg Modal Price",data:values,backgroundColor:"#002147"}]
    }
  });
}

function buildTrendChart(data){
  destroyChart(trendChart);
  if(!data.length) return;

  const byDate={};
  data.forEach(r=>{
    const d=r.arrival_date;
    const p=parseFloat(r.modal_price||0);
    if(d && !isNaN(p)) byDate[d]=(byDate[d]||[]).concat(p);
  });

  const dates=Object.keys(byDate).slice(-30);
  const values=dates.map(d=>{
    const a=byDate[d];
    return (a.reduce((x,y)=>x+y,0)/a.length).toFixed(1);
  });

  trendChart=new Chart(trendChart,{
    type:"line",
    data:{ labels:dates,
      datasets:[{label:"Average Modal Price",data:values,borderColor:"#002147",tension:.3}]
    }
  });
}

/* ================= EXPORT ================= */
function downloadCSV(){
  if(!allData.length) return;
  let csv=Object.keys(allData[0]).join(",")+"\n";
  allData.forEach(r=>csv+=Object.values(r).join(",")+"\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download="mandi_prices.csv";
  a.click();
}

/* ================= DARK MODE ================= */
function toggleDark(){
  document.body.classList.toggle("dark");
}

/* ================= AUTO DAILY REFRESH ================= */
(function(){
  try{
    const key="mandi_last_refresh";
    const today=new Date().toISOString().slice(0,10);
    if(localStorage.getItem(key)!==today){
      localStorage.setItem(key,today);
      setTimeout(loadData,1500);
    }
  }catch{}
})();
</script>

</body>
</html>
