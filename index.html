<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Real-time AQI | Govt Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== THEME ===== */
:root{
  --bg:#eef3f9;
  --card:#ffffff;
  --text:#1f2937;
  --blue:#0b5ed7;
}
body{
  margin:0;
  font-family:Segoe UI,Arial,sans-serif;
  background:linear-gradient(135deg,#e8eef7,#f7faff);
  color:var(--text);
}

/* HEADER */
header{
  background:linear-gradient(90deg,#0b3c6d,#0b5ed7);
  color:#fff;
  padding:18px;
  box-shadow:0 6px 20px rgba(0,0,0,.3);
}
header h1{margin:0;font-size:22px}
header p{margin:4px 0 0;font-size:13px}

/* ERROR BAR */
#globalError{
  display:none;
  background:#b91c1c;
  color:#fff;
  padding:10px;
  text-align:center;
  font-size:13px;
  animation:slideDown .3s ease;
}

/* LAYOUT */
.container{max-width:1400px;margin:auto;padding:16px}

/* CARD */
.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.18);
  animation:slideUpFade .5s ease both;
}

/* CONTROLS */
select,button{
  padding:10px 12px;
  margin:4px;
  border-radius:10px;
  border:1px solid #d1d5db;
}
button{
  background:linear-gradient(145deg,#0b5ed7,#084298);
  color:#fff;
  border:none;
  cursor:pointer;
}

/* TABLE */
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px;border-bottom:1px solid #e5e7eb}
th{background:#f1f5f9}

/* AQI COLORS */
.good{color:#15803d;font-weight:600}
.moderate{color:#b45309;font-weight:600}
.poor{color:#b91c1c;font-weight:600}

/* FOOTER */
footer{
  background:#f8fafc;
  border-top:2px solid #0b5ed7;
  padding:14px;
  text-align:center;
  font-size:12px;
}

/* ANIMATIONS */
@keyframes slideUpFade{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:none}
}
@keyframes slideDown{
  from{transform:translateY(-120%)}
  to{transform:translateY(0)}
}
</style>
</head>

<body>

<div id="globalError">‚ö†Ô∏è Error</div>

<header>
  <h1>Real-time Air Quality Index (AQI)</h1>
  <p>Open Government Data Platform India (NIC)</p>
</header>

<div class="container">

<div class="card">
  <button onclick="loadData()">Load AQI Data</button>
  <select id="cityFilter"></select>
  <select id="stationFilter"></select>
  <span id="status">Idle</span>
</div>

<div class="card">
  <h3>üìä Average AQI by City</h3>
  <canvas id="aqiChart" height="220"></canvas>
</div>

<div class="card" style="overflow-x:auto">
  <table id="table"></table>
</div>

<!-- data.gov.in widget -->
<div class="widget" style="text-align:center;margin-top:20px;">
  <a href="https://data.gov.in/catalogs/?ministry=Ministry of Personnel, Public Grievances and Pensions" target="_blank">
    <img src="https://data.gov.in/files/ogdpv2cms/s3fs-public/link_to_us/banner391x67.jpg">
  </a>
</div>

</div>

<footer>
  <div>Data Source: Open Government Data Platform India (data.gov.in)</div>
  <div>Designed & Developed by <strong>Rankaj Kumar</strong></div>
</footer>

<script>
/* ===== CONFIG ===== */
const API_KEY="579b464db66ec23bdd000001dd4bec4f88d44e427141d80a8f9a5fcc";
const RESOURCE_ID="3b01bcb8-0b14-4abf-b6f2-2c5c4c09f7b0";
const DEFAULT_CITY="Delhi";

let allData=[], chart=null;

/* ===== ERROR HANDLING ===== */
function showError(msg){
  const e=document.getElementById("globalError");
  e.innerText="‚ö†Ô∏è "+msg;
  e.style.display="block";
}
function clearError(){
  globalError.style.display="none";
}
window.onerror=()=>{showError("Unexpected system error");return true};
window.addEventListener("unhandledrejection",()=>showError("Network / API error"));

/* ===== LOAD DATA (CITY REQUIRED) ===== */
async function loadData(city=DEFAULT_CITY){
  clearError();
  status.innerText="Loading AQI data...";
  try{
    const url=`https://api.data.gov.in/resource/${RESOURCE_ID}?api-key=${API_KEY}&format=json&limit=500&filters[city]=${encodeURIComponent(city)}`;
    const res=await fetch(url);
    if(!res.ok) throw "API error";
    const json=await res.json();

    if(!json.records || json.records.length===0){
      throw "No data";
    }

    allData=json.records
      .map(r=>({
        city:r.city||"",
        station:r.station||"",
        aqi:Number(r.pollutant_avg)
      }))
      .filter(r=>r.city && r.station && !isNaN(r.aqi));

    if(allData.length===0) throw "Filtered empty";

    buildFilters();
    applyFilters();
    status.innerText=`Loaded ${allData.length} records (${city})`;

  }catch(e){
    status.innerText="Error loading data";
    showError("AQI data not available right now");
    console.error(e);
  }
}

/* ===== FILTERS ===== */
function buildFilters(){
  cityFilter.innerHTML='<option value="">Select City</option>';
  stationFilter.innerHTML='<option value="">All Stations</option>';

  const cities=[...new Set(allData.map(d=>d.city))];
  cities.forEach(c=>cityFilter.innerHTML+=`<option>${c}</option>`);

  cityFilter.onchange=()=>{
    if(cityFilter.value) loadData(cityFilter.value);
  };
  stationFilter.onchange=applyFilters;
}

/* ===== APPLY FILTER ===== */
function applyFilters(){
  const s=stationFilter.value;
  const f=allData.filter(d=>!s || d.station===s);
  buildTable(f);
  buildChart(f);
}

/* ===== TABLE ===== */
function buildTable(data){
  if(!data.length){table.innerHTML="";return;}
  let html="<tr><th>City</th><th>Station</th><th>AQI</th></tr>";
  data.forEach(d=>{
    let cls=d.aqi<=50?"good":d.aqi<=100?"moderate":"poor";
    html+=`<tr>
      <td>${d.city}</td>
      <td>${d.station}</td>
      <td class="${cls}">${d.aqi}</td>
    </tr>`;
  });
  table.innerHTML=html;
}

/* ===== CHART ===== */
function buildChart(data){
  if(chart) chart.destroy();
  if(!data.length) return;

  const map={};
  data.forEach(d=>(map[d.city]??=[]).push(d.aqi));
  const labels=Object.keys(map).slice(0,8);
  const values=labels.map(k=>{
    const a=map[k];
    return (a.reduce((x,y)=>x+y,0)/a.length).toFixed(1);
  });

  chart=new Chart(aqiChart,{
    type:"bar",
    data:{labels,datasets:[{label:"Average AQI",data:values,backgroundColor:"#0b5ed7"}]},
    options:{animation:{duration:600}}
  });
}

/* AUTO LOAD */
window.addEventListener("load",()=>loadData());
</script>

</body>
</html>
