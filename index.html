<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Daily Mandi Prices | Government of India</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f2f6fa;
  --card:#ffffff;
  --text:#1f2937;
  --blue:#002147;
  --border:#cfd8e3;
}
.dark{
  --bg:#0f172a;
  --card:#111827;
  --text:#e5e7eb;
  --blue:#2563eb;
  --border:#374151;
}
body{
  margin:0;
  font-family:Segoe UI,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.nic-top{
  background:#000;
  color:#fff;
  font-size:12px;
  padding:6px 14px;
}
header{
  background:linear-gradient(90deg,#001a33,#002147);
  color:#fff;
  padding:16px;
}
header h1{margin:0;font-size:22px}
header p{margin:4px 0 0;font-size:13px;opacity:.9}

.container{
  max-width:1400px;
  margin:auto;
  padding:16px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:6px;
  padding:14px;
  margin-bottom:14px;
}
button,select,input{
  padding:8px 10px;
  margin:4px;
  border:1px solid var(--border);
  border-radius:4px;
}
button{
  background:var(--blue);
  color:#fff;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border:1px solid var(--border);
  padding:6px;
  white-space:nowrap;
}
th{background:#e6effa}
.dark th{background:#1f2937}

/* GLOBAL ERROR BAR */
#globalError{
  display:none;
  background:#b91c1c;
  color:#fff;
  padding:10px 14px;
  font-size:13px;
  text-align:center;
}

footer{
  background:#f8fafc;
  border-top:2px solid #002147;
  padding:12px;
  text-align:center;
  font-size:12px;
  color:#374151;
}
.dark footer{
  background:#020617;
  color:#cbd5f5;
}
</style>
</head>

<body>

<div id="globalError">‚ö†Ô∏è System Error</div>

<div class="nic-top">
  Government of India | Ministry of Agriculture & Farmers Welfare
</div>

<header>
  <h1>Daily Market (Mandi) Prices</h1>
  <p>Open Government Data Platform India (NIC)</p>
</header>

<div class="container">

<div class="card">
  <button onclick="loadData()">Load / Refresh Data</button>
  <button onclick="toggleDark()">üåô Dark</button>
  <button onclick="downloadCSV()">‚¨á CSV</button><br>

  <select id="stateFilter"></select>
  <select id="districtFilter"></select>

  <input type="date" id="dateFilter">
  <input type="text" id="search" placeholder="Search mandi / commodity">

  <div id="lastUpdated" style="margin-top:6px;font-size:13px;">Last Updated: ‚Äî</div>
  <div id="status" style="margin-top:4px;">Idle</div>
</div>

<div class="card">
  <h3>üìä Commodity-wise Comparison</h3>
  <canvas id="commodityChart"></canvas>
</div>

<div class="card">
  <h3>üìÖ Last 30 Days Price Trend</h3>
  <canvas id="trendChart"></canvas>
</div>

<div class="card" style="overflow-x:auto">
  <table id="table"></table>
</div>

</div>

<footer>
  <div>Data Source: Open Government Data Platform India (data.gov.in)</div>
  <div style="margin-top:4px;font-weight:500;">
    Designed & Developed by <strong>Rankaj Kumar</strong>
  </div>
</footer>

<script>
/* ================= CONFIG ================= */
const API_KEY = "579b464db66ec23bdd000001dd4bec4f88d44e427141d80a8f9a5fcc";
const RESOURCE_ID = "9ef84268-d588-465a-a308-a864a43d0070";

/* ================= STATE ================= */
let allData = [];
let commodityChart = null;
let trendChart = null;

/* ================= ERROR SYSTEM ================= */
function showError(msg){
  const box = document.getElementById("globalError");
  box.innerText = "‚ö†Ô∏è " + msg;
  box.style.display = "block";
  setTimeout(()=>box.style.display="none",15000);
}
window.onerror = () => { showError("Unexpected system error occurred."); return true; };
window.addEventListener("unhandledrejection",()=>showError("Network or API error."));

/* ================= HELPERS ================= */
function getISTTime(){
  return new Date().toLocaleString("en-IN",{timeZone:"Asia/Kolkata"});
}
function updateLastUpdated(){
  const t = getISTTime();
  localStorage.setItem("mandi_last_updated",t);
  lastUpdated.innerText = "Last Updated: " + t + " (IST)";
}
(function(){
  const t = localStorage.getItem("mandi_last_updated");
  if(t) lastUpdated.innerText = "Last Updated: " + t + " (IST)";
})();

function normalize(r){
  return {
    state: r.state || r.State || "",
    district: r.district || r.District || "",
    market: r.market || r.Market || "",
    commodity: r.commodity || r.Commodity || "",
    arrival_date: r.arrival_date || r.Arrival_Date || "",
    modal_price: r.modal_price || r.Modal_Price || "0"
  };
}

/* ================= LOAD DATA (JSON SAFE) ================= */
async function loadData(){
  status.innerText="Loading data...";
  try{
    const res = await fetch(
      `https://api.data.gov.in/resource/${RESOURCE_ID}?api-key=${API_KEY}&format=json&limit=500`
    );
    if(!res.ok) throw "API error";
    const json = await res.json();
    if(!json.records || !json.records.length){
      status.innerText="No data received";
      return;
    }
    allData = json.records.map(normalize);
    buildStateDistrict();
    applyFilters();
    updateLastUpdated();
    status.innerText = `Loaded ${allData.length} records`;
  }catch{
    status.innerText="Failed to load data";
    showError("Data service temporarily unavailable.");
  }
}

/* ================= FILTERS ================= */
function buildStateDistrict(){
  stateFilter.innerHTML='<option value="">All States</option>';
  districtFilter.innerHTML='<option value="">All Districts</option>';

  [...new Set(allData.map(r=>r.state).filter(Boolean))]
    .sort().forEach(s=>stateFilter.innerHTML+=`<option>${s}</option>`);

  stateFilter.onchange = ()=>{
    districtFilter.innerHTML='<option value="">All Districts</option>';
    [...new Set(allData.filter(r=>r.state===stateFilter.value)
      .map(r=>r.district).filter(Boolean))]
      .sort().forEach(d=>districtFilter.innerHTML+=`<option>${d}</option>`);
    applyFilters();
  };
  districtFilter.onchange = applyFilters;
  search.onkeyup = applyFilters;
  dateFilter.onchange = applyFilters;
}

/* ================= APPLY FILTER ================= */
function applyFilters(){
  const s=stateFilter.value, d=districtFilter.value;
  const q=search.value.toLowerCase(), date=dateFilter.value;

  const f = allData.filter(r=>{
    if(s && r.state!==s) return false;
    if(d && r.district!==d) return false;
    if(date && !r.arrival_date.includes(date)) return false;
    if(q && !(r.market+r.commodity).toLowerCase().includes(q)) return false;
    return true;
  });

  buildTable(f);
  buildCommodityChart(f);
  buildTrendChart(f);
}

/* ================= TABLE ================= */
function buildTable(data){
  if(!data.length){table.innerHTML="";return;}
  let html="<tr>";
  Object.keys(data[0]).forEach(k=>html+=`<th>${k}</th>`);
  html+="</tr>";
  data.forEach(r=>{
    html+="<tr>";
    Object.values(r).forEach(v=>html+=`<td>${v}</td>`);
    html+="</tr>";
  });
  table.innerHTML=html;
}

/* ================= CHARTS ================= */
function buildCommodityChart(data){
  if(commodityChart) commodityChart.destroy();
  if(!data.length) return;

  const map={};
  data.forEach(r=>{
    const p=parseFloat(r.modal_price||0);
    if(!isNaN(p)) (map[r.commodity]??=[]).push(p);
  });

  const labels=Object.keys(map).slice(0,8);
  const values=labels.map(k=>{
    const a=map[k]; return (a.reduce((x,y)=>x+y,0)/a.length).toFixed(1);
  });

  commodityChart=new Chart(commodityChart,{
    type:"bar",
    data:{labels,datasets:[{label:"Avg Price",data:values,backgroundColor:"#002147"}]}
  });
}

function buildTrendChart(data){
  if(trendChart) trendChart.destroy();
  if(!data.length) return;

  const byDate={};
  data.forEach(r=>{
    const p=parseFloat(r.modal_price||0);
    if(r.arrival_date && !isNaN(p))
      (byDate[r.arrival_date]??=[]).push(p);
  });

  const dates=Object.keys(byDate).slice(-30);
  const values=dates.map(d=>{
    const a=byDate[d]; return (a.reduce((x,y)=>x+y,0)/a.length).toFixed(1);
  });

  trendChart=new Chart(trendChart,{
    type:"line",
    data:{labels:dates,
      datasets:[{label:"Avg Modal Price",data:values,borderColor:"#002147",tension:.3}]}
  });
}

/* ================= EXPORT & UI ================= */
function downloadCSV(){
  if(!allData.length) return;
  let csv=Object.keys(allData[0]).join(",")+"\n";
  allData.forEach(r=>csv+=Object.values(r).join(",")+"\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download="mandi_prices.csv";
  a.click();
}
function toggleDark(){document.body.classList.toggle("dark");}

/* ================= AUTO DAILY REFRESH ================= */
(function(){
  const k="mandi_daily_refresh";
  const t=new Date().toISOString().slice(0,10);
  if(localStorage.getItem(k)!==t){
    localStorage.setItem(k,t);
    setTimeout(loadData,1500);
  }
})();
</script>

</body>
</html>
